name: Desmond Null Bot – Guide Drift Detector
on:
  schedule:
    - cron: '0 2 * * 0'   # Every Sunday 02:00 UTC
  workflow_dispatch:     # Manual trigger if you want

jobs:
  keep-guide-true:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GROK_PAT }}

      - name: Fetch current vendor pages
        run: |
          mkdir -p temp/vendor
          curl -s "https://developers.facebook.com/docs/threads/get-started" > temp/vendor/threads.md
          curl -s "https://console.groq.com/docs/quickstart" > temp/vendor/groq.md
          curl -s "https://learn.microsoft.com/en-us/azure/static-web-apps/get-started-portal" > temp/vendor/azure-static.md
          curl -s "https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token#fine-grained-personal-access-tokens" > temp/vendor/github-pat.md

      - name: Check for drift
        id: drift
        run: |
          if ! cmp -s temp/vendor/threads.md temp/vendor/last-threads.md 2>/dev/null || \
             ! cmp -s temp/vendor/groq.md temp/vendor/last-groq.md 2>/dev/null || \
             ! cmp -s temp/vendor/azure-static.md temp/vendor/last-azure-static.md 2>/dev/null || \
             ! cmp -s temp/vendor/github-pat.md temp/vendor/last-github-pat.md 2>/dev/null; then
            echo "drift=true" >> $GITHUB_OUTPUT
          else
            echo "drift=false" >> $GITHUB_OUTPUT
          fi

      - name: Update our living guide (if drift)
        if: steps.drift.outputs.drift == 'true'
        run: |
          # This is where the ghost rewrites our guide using Groq (placeholder for now)
          echo "Vendor drift detected — our guide will be updated automatically"
          # Future step: call Groq to rewrite wiki/Desmond-Null-Bot-Setup-Guide.md
          git add wiki/Desmond-Null-Bot-Setup-Guide.md
          git commit -m "AUTO: Setup guide updated – vendor drift fixed $(date +%Y-%m-%d)"
          git push

      - name: Cache current vendor pages for next week
        run: cp temp/vendor/* temp/vendor/last-*
